<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AI PC (Web UI)</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 1fr 350px;
      gap: 20px;
    }
    .main-content {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .sidebar {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .card {
      background: white;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1), 0 2px 4px rgba(0,0,0,0.06);
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 15px rgba(0,0,0,0.1), 0 4px 6px rgba(0,0,0,0.05);
    }
    h1 {
      margin: 0 0 8px 0;
      color: white;
      font-size: 32px;
      font-weight: 700;
      text-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .subtitle {
      color: rgba(255,255,255,0.9);
      font-size: 14px;
      margin-bottom: 20px;
    }
    h2, h3 {
      margin: 0 0 16px 0;
      color: #1a202c;
      font-weight: 600;
    }
    h3 {
      font-size: 18px;
      border-bottom: 2px solid #e2e8f0;
      padding-bottom: 8px;
    }
    .row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: flex-start;
    }
    input, textarea, select, button {
      font-size: 14px;
      font-family: inherit;
    }
    textarea {
      width: 100%;
      min-height: 80px;
      padding: 12px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      resize: vertical;
      transition: border-color 0.2s;
    }
    textarea:focus {
      outline: none;
      border-color: #667eea;
    }
    input[type="text"], input[type="url"], select {
      padding: 10px 12px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      width: 100%;
      transition: border-color 0.2s;
    }
    input:focus, select:focus {
      outline: none;
      border-color: #667eea;
    }
    button {
      padding: 10px 20px;
      cursor: pointer;
      border: none;
      border-radius: 8px;
      font-weight: 500;
      transition: all 0.2s;
      white-space: nowrap;
    }
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(102, 126, 234, 0.4);
    }
    .btn-secondary {
      background: #e2e8f0;
      color: #4a5568;
    }
    .btn-secondary:hover {
      background: #cbd5e0;
    }
    .btn-danger {
      background: #ef4444;
      color: white;
    }
    .btn-danger:hover {
      background: #dc2626;
    }
    .btn-success {
      background: #10b981;
      color: white;
    }
    .btn-success:hover {
      background: #059669;
    }
    .btn-group {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .status-box {
      padding: 12px;
      background: #f7fafc;
      border-radius: 8px;
      margin-top: 12px;
      font-size: 14px;
    }
    .status-success {
      background: #d1fae5;
      color: #065f46;
    }
    .status-error {
      background: #fee2e2;
      color: #991b1b;
    }
    .status-info {
      background: #dbeafe;
      color: #1e40af;
    }
    .muted {
      color: #718096;
      font-size: 13px;
    }
    .paths {
      white-space: pre-wrap;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      background: #f7fafc;
      padding: 12px;
      border-radius: 8px;
      max-height: 400px;
      overflow-y: auto;
    }
    .badge {
      display: inline-block;
      padding: 4px 10px;
      background: #e2e8f0;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      margin-left: 6px;
      color: #4a5568;
    }
    .badge-primary {
      background: #667eea;
      color: white;
    }
    .badge-success {
      background: #10b981;
      color: white;
    }
    .indexed-path-item {
      padding: 12px;
      background: #f7fafc;
      border-radius: 8px;
      margin-bottom: 8px;
      border-left: 4px solid #667eea;
    }
    .indexed-path-item:hover {
      background: #edf2f7;
    }
    .settings-section {
      margin-bottom: 20px;
      padding-bottom: 20px;
      border-bottom: 1px solid #e2e8f0;
    }
    .settings-section:last-child {
      border-bottom: none;
    }
    .form-group {
      margin-bottom: 16px;
    }
    .form-label {
      display: block;
      margin-bottom: 6px;
      font-weight: 500;
      color: #4a5568;
      font-size: 14px;
    }
    .form-hint {
      font-size: 12px;
      color: #718096;
      margin-top: 4px;
    }
    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 24px;
    }
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #cbd5e0;
      transition: .4s;
      border-radius: 24px;
    }
    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    input:checked + .toggle-slider {
      background-color: #667eea;
    }
    input:checked + .toggle-slider:before {
      transform: translateX(26px);
    }
    .model-selector {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .model-selector select {
      flex: 1;
    }
    .refresh-btn {
      padding: 8px 12px;
      font-size: 12px;
    }
    .llm-status {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: #f7fafc;
      border-radius: 6px;
      font-size: 12px;
      margin-bottom: 12px;
    }
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #10b981;
    }
    .status-dot.inactive {
      background: #ef4444;
    }
    .chat-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }
    .ai-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }
    .scrollable {
      max-height: 500px;
      overflow-y: auto;
    }
    .answer-box {
      background: #f7fafc;
      padding: 16px;
      border-radius: 8px;
      margin-top: 12px;
      white-space: pre-wrap;
      line-height: 1.6;
    }
    .results-box {
      margin-top: 12px;
    }
    .result-item {
      padding: 12px;
      background: white;
      border-radius: 8px;
      margin-bottom: 8px;
      border-left: 3px solid #667eea;
    }
    .result-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    .result-item-path {
      font-weight: 600;
      color: #2d3748;
      font-size: 13px;
    }
    .result-item-text {
      color: #4a5568;
      font-size: 12px;
      margin-top: 6px;
      line-height: 1.5;
    }
    @media (max-width: 1200px) {
      .container {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <h1>ğŸ¤– AI PC</h1>
  <div class="subtitle">ë¡œì»¬ íŒŒì¼ ê²€ìƒ‰ ë° AI ì§ˆì˜ì‘ë‹µ ì‹œìŠ¤í…œ</div>

  <div class="container">
    <!-- ë©”ì¸ ì½˜í…ì¸  ì˜ì—­ -->
    <div class="main-content">
      <!-- ì¸ë±ì‹± ì„¹ì…˜ -->
      <div class="card">
        <h3>ğŸ“ íŒŒì¼ ì¸ë±ì‹±</h3>
        <div class="muted" style="margin-bottom:12px">ì—¬ëŸ¬ ê²½ë¡œë¥¼ ì„¸ë¯¸ì½œë¡ (;)ìœ¼ë¡œ êµ¬ë¶„í•˜ì—¬ ì…ë ¥í•˜ì„¸ìš”</div>
        <div class="row">
          <textarea id="root" placeholder="ì˜ˆ: C:\Users\me\Documents&#10;ë˜ëŠ” ì—¬ëŸ¬ ê²½ë¡œ: C:\Users\me\Documents;D:\Projects"></textarea>
          <div style="display:flex;flex-direction:column;gap:8px;min-width:120px">
            <button class="btn-primary" onclick="doIndex()">Index</button>
            <button class="btn-secondary" onclick="selectFolder()" style="font-size:12px">í´ë” ì„ íƒ</button>
            <button class="btn-secondary" onclick="addPath()" style="font-size:12px">ê²½ë¡œ ì¶”ê°€</button>
          </div>
        </div>
        <div id="indexStatus" class="status-box"></div>
      </div>

      <!-- Chat / Search ì„¹ì…˜ -->
      <div class="card">
        <div class="chat-header">
          <h3 style="margin:0;border:none">ğŸ’¬ AI Chat</h3>
          <div id="llmStatus" class="llm-status">
            <span class="status-dot" id="llmStatusDot"></span>
            <span id="llmStatusText">ë¡œë”© ì¤‘...</span>
          </div>
        </div>
        <div class="muted" style="margin-bottom:12px">AIê°€ ì¸ë±ì‹±ëœ íŒŒì¼ì„ ê²€ìƒ‰í•˜ê³  ë‹µë³€ì„ ìƒì„±í•©ë‹ˆë‹¤</div>
        <textarea id="q" placeholder="ì˜ˆ: 2025 ìˆ˜ì… ì˜ˆìƒì¹˜ ì•Œë ¤ì¤˜, AI ê°•ì˜ìë£Œ ìš”ì•½í•´ì¤˜"></textarea>
        <div class="btn-group" style="margin-top:12px">
          <button class="btn-primary" onclick="doChat()">
            <span id="chatBtnText">ğŸ¤– AI Chat</span>
          </button>
          <button class="btn-secondary" onclick="doSearch()">ğŸ” Search Only</button>
        </div>
        <div id="answer" class="answer-box" style="display:none"></div>
        <div id="results" class="results-box" style="display:none"></div>
      </div>
    </div>

    <!-- ì‚¬ì´ë“œë°” -->
    <div class="sidebar">
      <!-- ì„¤ì • ì„¹ì…˜ -->
      <div class="card">
        <h3>âš™ï¸ ì„¤ì •</h3>
        <div class="settings-section">
          <div class="form-group">
            <label class="form-label">LLM ëª¨ë“œ</label>
            <select id="modeSelect" onchange="onModeChange()">
              <option value="internal">ë‚´ë¶€ API (Ollama)</option>
              <option value="local">ë¡œì»¬ LLM (llama.cpp)</option>
            </select>
            <div class="form-hint">ì‚¬ìš©í•  LLM ëª¨ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”</div>
          </div>

          <div id="internalSettings">
            <div class="form-group">
              <label class="form-label">API URL</label>
              <input type="url" id="internalUrl" placeholder="http://127.0.0.1:11434/v1">
            </div>
            <div class="form-group">
              <label class="form-label">API Key</label>
              <input type="text" id="internalKey" placeholder="ollama">
            </div>
            <div class="form-group">
              <label class="form-label">ëª¨ë¸</label>
              <div class="model-selector">
                <select id="internalModel">
                  <option value="">ë¡œë”© ì¤‘...</option>
                </select>
                <button class="btn-secondary refresh-btn" onclick="loadOllamaModels()">ğŸ”„</button>
              </div>
            </div>
            
            <div class="form-group" style="margin-top:20px;padding-top:20px;border-top:1px solid #e2e8f0">
              <label class="form-label" style="display:flex;align-items:center;gap:8px">
                <input type="checkbox" id="useProxy" onchange="onProxyToggle()" style="width:auto;margin:0">
                Proxy ì‚¬ìš© (liteproxy â†’ fabrix LLM)
              </label>
              <div class="form-hint">liteproxyë¥¼ í†µí•œ ë‚´ë¶€ fabrix LLM í˜¸ì¶œ</div>
            </div>
            
            <div id="proxySettings" style="display:none">
              <div class="form-group">
                <label class="form-label">Proxy URL</label>
                <input type="url" id="proxyUrl" placeholder="http://127.0.0.1:8080/v1">
                <div class="form-hint">liteproxy ì„œë²„ ì£¼ì†Œ</div>
              </div>
              <div class="form-group">
                <label class="form-label">Proxy API Key</label>
                <input type="text" id="proxyKey" placeholder="(ì„ íƒì‚¬í•­)">
                <div class="form-hint">í•„ìš”í•œ ê²½ìš° API í‚¤ ì…ë ¥</div>
              </div>
            </div>
          </div>

          <div id="localSettings" style="display:none">
            <div class="form-group">
              <label class="form-label">ëª¨ë¸ ê²½ë¡œ</label>
              <input type="text" id="localPath" placeholder="./models/model.gguf">
            </div>
          </div>

          <button class="btn-success" onclick="saveSettings()" style="width:100%;margin-top:12px">ğŸ’¾ ì„¤ì • ì €ì¥</button>
        </div>
      </div>

      <!-- ì¸ë±ì‹±ëœ ê²½ë¡œ ì„¹ì…˜ -->
      <div class="card">
        <h3>ğŸ“‚ ì¸ë±ì‹±ëœ ê²½ë¡œ</h3>
        <div id="indexedPaths" class="scrollable">
          <div class="muted">ë¡œë”© ì¤‘...</div>
        </div>
      </div>
    </div>
  </div>

<script>
const api = (path) => `${location.origin}${path}`;

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
window.addEventListener('DOMContentLoaded', () => {
  loadSettings();
  loadIndexedPaths();
  loadOllamaModels();
  updateLLMStatus();
});

// ì„¤ì • ë¡œë“œ
async function loadSettings() {
  try {
    const r = await fetch(api('/settings'));
    const j = await r.json();
    
    document.getElementById('modeSelect').value = j.mode || 'internal';
    document.getElementById('internalUrl').value = j.internal_base_url || '';
    document.getElementById('internalKey').value = j.internal_api_key || '';
    document.getElementById('internalModel').value = j.internal_model || '';
    document.getElementById('localPath').value = j.local_gguf_path || '';
    document.getElementById('useProxy').checked = j.use_proxy || false;
    document.getElementById('proxyUrl').value = j.proxy_url || '';
    document.getElementById('proxyKey').value = j.proxy_api_key || '';
    
    onModeChange();
    onProxyToggle();
  } catch(e) {
    console.error('ì„¤ì • ë¡œë“œ ì‹¤íŒ¨:', e);
  }
}

// ëª¨ë“œ ë³€ê²½
function onModeChange() {
  const mode = document.getElementById('modeSelect').value;
  const internalSettings = document.getElementById('internalSettings');
  const localSettings = document.getElementById('localSettings');
  
  if (mode === 'internal') {
    internalSettings.style.display = 'block';
    localSettings.style.display = 'none';
  } else {
    internalSettings.style.display = 'none';
    localSettings.style.display = 'block';
  }
  updateLLMStatus();
}

// Proxy í† ê¸€
function onProxyToggle() {
  const useProxy = document.getElementById('useProxy').checked;
  const proxySettings = document.getElementById('proxySettings');
  proxySettings.style.display = useProxy ? 'block' : 'none';
  updateLLMStatus();
}

// Ollama ëª¨ë¸ ëª©ë¡ ë¡œë“œ
async function loadOllamaModels() {
  const select = document.getElementById('internalModel');
  select.innerHTML = '<option value="">ë¡œë”© ì¤‘...</option>';
  
  try {
    const r = await fetch(api('/ollama-models'));
    const j = await r.json();
    
    if (j.available && j.models && j.models.length > 0) {
      select.innerHTML = j.models.map(m => 
        `<option value="${m}">${m}</option>`
      ).join('');
      
      // í˜„ì¬ ì„¤ì •ëœ ëª¨ë¸ ì„ íƒ
      const currentModel = document.getElementById('internalModel').getAttribute('data-current') || 
                          document.getElementById('internalModel').value;
      if (currentModel) {
        select.value = currentModel;
      }
    } else {
      select.innerHTML = '<option value="">ëª¨ë¸ ì—†ìŒ (Ollama ì„œë²„ í™•ì¸ í•„ìš”)</option>';
    }
  } catch(e) {
    select.innerHTML = '<option value="">ë¡œë“œ ì‹¤íŒ¨</option>';
    console.error('ëª¨ë¸ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', e);
  }
}

// ì„¤ì • ì €ì¥
async function saveSettings() {
  const mode = document.getElementById('modeSelect').value;
  const settings = {
    mode: mode,
    internal_base_url: document.getElementById('internalUrl').value,
    internal_api_key: document.getElementById('internalKey').value,
    internal_model: document.getElementById('internalModel').value,
    local_gguf_path: document.getElementById('localPath').value,
    use_proxy: document.getElementById('useProxy').checked,
    proxy_url: document.getElementById('proxyUrl').value,
    proxy_api_key: document.getElementById('proxyKey').value
  };
  
  try {
    const r = await fetch(api('/settings'), {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(settings)
    });
    const j = await r.json();
    
    if (j.success) {
      alert('ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.\në³€ê²½ì‚¬í•­ì„ ì ìš©í•˜ë ¤ë©´ ì„œë²„ë¥¼ ì¬ì‹œì‘í•˜ì„¸ìš”.');
      updateLLMStatus();
    } else {
      alert('ì„¤ì • ì €ì¥ ì‹¤íŒ¨: ' + (j.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
    }
  } catch(e) {
    alert('ì„¤ì • ì €ì¥ ì¤‘ ì˜¤ë¥˜: ' + e.message);
  }
}

// LLM ìƒíƒœ ì—…ë°ì´íŠ¸
async function updateLLMStatus() {
  const statusEl = document.getElementById('llmStatusText');
  const statusDot = document.getElementById('llmStatusDot');
  const mode = document.getElementById('modeSelect').value;
  
  if (mode === 'internal') {
    const model = document.getElementById('internalModel').value;
    if (model) {
      statusEl.textContent = `Ollama: ${model}`;
      statusDot.classList.remove('inactive');
    } else {
      statusEl.textContent = 'ëª¨ë¸ ë¯¸ì„ íƒ';
      statusDot.classList.add('inactive');
    }
  } else {
    const path = document.getElementById('localPath').value;
    if (path) {
      statusEl.textContent = 'ë¡œì»¬ LLM';
      statusDot.classList.remove('inactive');
    } else {
      statusEl.textContent = 'ëª¨ë¸ ê²½ë¡œ ì—†ìŒ';
      statusDot.classList.add('inactive');
    }
  }
}

// ì¸ë±ì‹±ëœ ê²½ë¡œ ë¡œë“œ
async function loadIndexedPaths(){
  try {
    const r = await fetch(api('/indexed-roots'));
    const j = await r.json();
    renderIndexedPaths(j.roots || []);
  } catch(e) {
    document.getElementById('indexedPaths').innerHTML = '<span style="color:red">ì˜¤ë¥˜: ' + e.message + '</span>';
  }
}

function renderIndexedPaths(roots){
  const el = document.getElementById('indexedPaths');
  if(!roots || roots.length === 0){
    el.innerHTML = '<div class="muted">ì¸ë±ì‹±ëœ ê²½ë¡œê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
    return;
  }
  
  let html = '';
  roots.forEach(root => {
    const date = new Date(root.indexed_at * 1000).toLocaleString('ko-KR');
    html += `
      <div class="indexed-path-item">
        <div style="font-weight:600;margin-bottom:6px;word-break:break-all">${root.root_path}</div>
        <div style="font-size:11px;color:#718096;margin-bottom:8px">
          íŒŒì¼: ${root.file_count} | ì²­í¬: ${root.chunk_count}<br/>
          ${date}
        </div>
        <button class="btn-danger" onclick="deletePath('${root.root_path.replace(/'/g, "\\'")}')" 
                style="width:100%;padding:6px;font-size:12px">ì‚­ì œ</button>
      </div>
    `;
  });
  el.innerHTML = html;
}

async function deletePath(rootPath){
  if(!confirm(`ì •ë§ë¡œ "${rootPath}" ê²½ë¡œì˜ ì¸ë±ì‹± ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)){
    return;
  }
  
  const statusEl = document.getElementById('indexStatus');
  statusEl.className = 'status-box status-info';
  statusEl.textContent = 'ì‚­ì œ ì¤‘...';
  
  try {
    const r = await fetch(api('/delete-path'), {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({root_path: rootPath})
    });
    const j = await r.json();
    if(j.deleted){
      statusEl.className = 'status-box status-success';
      statusEl.textContent = `ì‚­ì œ ì™„ë£Œ: ${j.deleted_files || 0}ê°œ íŒŒì¼, ${j.deleted_chunks || 0}ê°œ ì²­í¬ ì‚­ì œë¨`;
      loadIndexedPaths();
      setTimeout(() => {
        statusEl.textContent = '';
        statusEl.className = 'status-box';
      }, 3000);
    } else {
      statusEl.className = 'status-box status-error';
      statusEl.textContent = `ì‚­ì œ ì‹¤íŒ¨: ${j.error || j.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`;
    }
  } catch(e) {
    statusEl.className = 'status-box status-error';
    statusEl.textContent = `ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${e.message}`;
  }
}

async function selectFolder(){
  const statusEl = document.getElementById('indexStatus');
  statusEl.className = 'status-box status-info';
  statusEl.textContent = 'í´ë” ì„ íƒ ëŒ€í™”ìƒìë¥¼ ì—¬ëŠ” ì¤‘...';
  
  try {
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 120000);
    
    const r = await fetch(api('/select-folder'), {
      signal: controller.signal
    });
    
    clearTimeout(timeoutId);
    
    if(!r.ok){
      throw new Error(`ì„œë²„ ì˜¤ë¥˜: ${r.status} ${r.statusText}`);
    }
    
    const j = await r.json();
    
    if(j.error){
      statusEl.className = 'status-box status-error';
      statusEl.textContent = 'ê²½ê³ : ' + j.error;
      alert('í´ë” ì„ íƒ ì‹¤íŒ¨: ' + j.error + '\n\nê²½ë¡œë¥¼ ì§ì ‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    } else if(j.cancelled){
      statusEl.textContent = '';
      statusEl.className = 'status-box';
    } else if(j.path){
      const root = document.getElementById('root');
      const current = root.value.trim();
      if(current && !current.endsWith(';')){
        root.value = current + ';' + j.path;
      } else {
        root.value = current + j.path;
      }
      statusEl.className = 'status-box status-success';
      statusEl.textContent = 'ê²½ë¡œê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤: ' + j.path;
      loadIndexedPaths();
    }
  } catch(e) {
    if(e.name === 'AbortError'){
      statusEl.className = 'status-box status-error';
      statusEl.textContent = 'í´ë” ì„ íƒì´ ì‹œê°„ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤.';
      alert('í´ë” ì„ íƒì´ ì‹œê°„ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤.\n\nê²½ë¡œë¥¼ ì§ì ‘ ì…ë ¥í•˜ê±°ë‚˜, íŒŒì¼ íƒìƒ‰ê¸°ì—ì„œ ê²½ë¡œë¥¼ ë³µì‚¬í•˜ì—¬ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.');
    } else {
      statusEl.className = 'status-box status-error';
      statusEl.textContent = 'ì˜¤ë¥˜: ' + e.message;
      alert('í´ë” ì„ íƒ ì¤‘ ì˜¤ë¥˜: ' + e.message + '\n\nê²½ë¡œë¥¼ ì§ì ‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    }
  }
}

function addPath(){
  const root = document.getElementById('root');
  const current = root.value.trim();
  if(current && !current.endsWith(';')){
    root.value = current + ';';
  }
  root.focus();
}

async function doIndex(){
  const root = document.getElementById('root').value.trim();
  if(!root) {
    alert('ê²½ë¡œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”');
    return;
  }
  const el = document.getElementById('indexStatus');
  el.className = 'status-box status-info';
  el.textContent = "ì¸ë±ì‹± ì¤‘...";
  try {
    const r = await fetch(api('/index'),{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({root})
    });
    const j = await r.json();
    if(j.error){
      el.className = 'status-box status-error';
      el.textContent = "ì˜¤ë¥˜: " + j.error;
    } else if(j.summary){
      el.className = 'status-box status-success';
      el.innerHTML = "<b>ì¸ë±ì‹± ì™„ë£Œ</b><br/>" +
        "ê²½ë¡œ ìˆ˜: " + j.summary.total_roots + "<br/>" +
        "íŒŒì¼: " + j.summary.total_files + "<br/>" +
        "ì²­í¬: " + j.summary.total_chunks + "<br/>" +
        "ë²¡í„°: " + j.summary.total_vectors;
      loadIndexedPaths();
    } else {
      el.className = 'status-box status-error';
      el.textContent = JSON.stringify(j, null, 2);
    }
  } catch(e) {
    el.className = 'status-box status-error';
    el.textContent = "ì˜¤ë¥˜: " + e.message;
  }
}

function renderResults(items, snippets=null, ragSnippets=null){
  const box = document.getElementById('results');
  if((!items || items.length===0) && (!snippets || snippets.length===0) && (!ragSnippets || ragSnippets.length===0)){
    box.style.display='block';
    box.innerHTML = "<div class='muted'>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>";
    return;
  }
  box.style.display='block';
  
  let html = "<h4 style='margin-top:0'>ê²€ìƒ‰ ê²°ê³¼</h4>";
  if(items && items.length > 0) html += `<span class='badge badge-primary'>íŒŒì¼: ${items.length}</span>`;
  if(snippets && snippets.length > 0) html += `<span class='badge badge-success'>í‚¤ì›Œë“œ: ${snippets.length}</span>`;
  if(ragSnippets && ragSnippets.length > 0) html += `<span class='badge'>ì˜ë¯¸: ${ragSnippets.length}</span>`;
  
  const resultsContainer = document.createElement('div');
  resultsContainer.style.marginTop = '12px';
  
  // íŒŒì¼ ê²°ê³¼
  if(items && items.length > 0){
    items.forEach((it, idx)=>{
      const item = document.createElement('div');
      item.className = 'result-item';
      item.innerHTML = `
        <div class="result-item-header">
          <div class="result-item-path">${idx+1}. ${it.path || ''}</div>
          <div style="display:flex;gap:4px">
            <button class="btn-secondary" onclick="openPath('${(it.path || '').replace(/'/g, "\\'")}')" style="padding:4px 8px;font-size:11px" title="í´ë” ì—´ê¸°">ğŸ“ í´ë”</button>
            <button class="btn-primary" onclick="openFile('${(it.path || '').replace(/'/g, "\\'")}')" style="padding:4px 8px;font-size:11px" title="ë¬¸ì„œ ì—´ê¸°">ğŸ“„ ì—´ê¸°</button>
          </div>
        </div>
      `;
      resultsContainer.appendChild(item);
    });
  }
  
  // Chunk ê²°ê³¼
  if(snippets && snippets.length > 0){
    snippets.forEach((it, idx)=>{
      const item = document.createElement('div');
      item.className = 'result-item';
      const text = (it.text || '').substring(0, 200);
      item.innerHTML = `
        <div class="result-item-header">
          <div class="result-item-path">${idx+1}. ${it.path || ''}</div>
          <div style="display:flex;gap:4px">
            <button class="btn-secondary" onclick="openPath('${(it.path || '').replace(/'/g, "\\'")}')" style="padding:4px 8px;font-size:11px" title="í´ë” ì—´ê¸°">ğŸ“ í´ë”</button>
            <button class="btn-primary" onclick="openFile('${(it.path || '').replace(/'/g, "\\'")}')" style="padding:4px 8px;font-size:11px" title="ë¬¸ì„œ ì—´ê¸°">ğŸ“„ ì—´ê¸°</button>
          </div>
        </div>
        <div class="result-item-text">${text}${it.text && it.text.length > 200 ? '...' : ''}</div>
      `;
      resultsContainer.appendChild(item);
    });
  }
  
  // RAG ê²°ê³¼
  if(ragSnippets && ragSnippets.length > 0){
    ragSnippets.forEach((it, idx)=>{
      const item = document.createElement('div');
      item.className = 'result-item';
      const text = (it.text || '').substring(0, 200);
      item.innerHTML = `
        <div class="result-item-header">
          <div class="result-item-path">${idx+1}. ${it.path || ''}</div>
          <div style="display:flex;gap:4px">
            <button class="btn-secondary" onclick="openPath('${(it.path || '').replace(/'/g, "\\'")}')" style="padding:4px 8px;font-size:11px" title="í´ë” ì—´ê¸°">ğŸ“ í´ë”</button>
            <button class="btn-primary" onclick="openFile('${(it.path || '').replace(/'/g, "\\'")}')" style="padding:4px 8px;font-size:11px" title="ë¬¸ì„œ ì—´ê¸°">ğŸ“„ ì—´ê¸°</button>
          </div>
        </div>
        <div class="result-item-text">${text}${it.text && it.text.length > 200 ? '...' : ''}</div>
      `;
      resultsContainer.appendChild(item);
    });
  }
  
  box.innerHTML = html;
  box.appendChild(resultsContainer);
}

async function openPath(path){
  // íŒŒì¼ì´ ìˆëŠ” í´ë”ë¥¼ ì—´ê³  íŒŒì¼ì„ ì„ íƒ
  await fetch(api('/open'),{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({path})
  });
}

async function openFile(path){
  // íŒŒì¼ì„ ê¸°ë³¸ ì• í”Œë¦¬ì¼€ì´ì…˜ìœ¼ë¡œ ì§ì ‘ ì—´ê¸°
  await fetch(api('/open-file'),{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({path})
  });
}

async function doSearch(){
  const message = document.getElementById('q').value.trim();
  if(!message) return;
  
  const resultsEl = document.getElementById('results');
  resultsEl.style.display = 'block';
  resultsEl.innerHTML = '<div class="muted">ê²€ìƒ‰ ì¤‘...</div>';
  
  const r = await fetch(api('/search'),{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({message})
  });
  const j = await r.json();
  document.getElementById('answer').style.display='none';
  renderResults(j.results);
}

async function doChat(){
  const message = document.getElementById('q').value.trim();
  if(!message) {
    alert('ì§ˆë¬¸ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
    return;
  }
  
  const a = document.getElementById('answer');
  const resultsEl = document.getElementById('results');
  a.style.display='block';
  resultsEl.style.display='block';
  a.innerHTML = "<div class='muted'>ğŸ¤– AIê°€ ë‹µë³€ì„ ìƒì„±í•˜ëŠ” ì¤‘...</div>";
  resultsEl.innerHTML = '<div class="muted">ê²€ìƒ‰ ì¤‘...</div>';
  
  try {
    const r = await fetch(api('/chat'),{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({message})
    });
    
    if(!r.ok){
      throw new Error(`ì„œë²„ ì˜¤ë¥˜: ${r.status} ${r.statusText}`);
    }
    
    const j = await r.json();
    
    // ë‹µë³€ í‘œì‹œ
    let answerHtml = "<h4 style='margin-top:0'>ğŸ¤– AI ë‹µë³€</h4>";
    
    // ëª¨ë¸ ì •ë³´ í‘œì‹œ
    if(j.model_info){
      const modelInfo = j.model_info;
      const modelName = modelInfo.model || 'unknown';
      const modeText = modelInfo.mode === 'internal' ? 'Ollama' : 'ë¡œì»¬ LLM';
      const statusText = modelInfo.using_llm ? 'âœ… LLM ì‚¬ìš© ì¤‘' : 'âŒ LLM ë¯¸ì‚¬ìš©';
      answerHtml += `<div style='font-size:12px;color:#718096;margin-bottom:8px;padding:6px;background:#f7fafc;border-radius:6px'>
        ${statusText} | ${modeText}: ${modelName}
      </div>`;
    }
    
    answerHtml += "<div>";
    if(j.answer){
      answerHtml += j.answer;
    } else {
      answerHtml += "(ë‹µë³€ ì—†ìŒ)";
    }
    answerHtml += "</div>";
    
    if(j.error){
      answerHtml += "<div style='color:#ef4444;margin-top:8px;padding:8px;background:#fee2e2;border-radius:6px'>ì˜¤ë¥˜: " + j.error + "</div>";
    }
    
    a.innerHTML = answerHtml;
    
    // ê²°ê³¼ í‘œì‹œ
    renderResults(j.results||[], j.snippets||[], j.rag_snippets||[]);
    
    // íŒŒì¼ ì—´ê¸° ì•¡ì…˜
    if(j.action && j.action.path){
      const btn = document.createElement('button');
      btn.className = 'btn-primary';
      btn.textContent = "ğŸ“‚ ì œì•ˆëœ íŒŒì¼ ì—´ê¸°";
      btn.style.marginTop='12px';
      btn.onclick = ()=>openPath(j.action.path);
      a.appendChild(btn);
    }
  } catch(e) {
    a.innerHTML = "<div style='color:#ef4444;padding:12px;background:#fee2e2;border-radius:8px'>ì˜¤ë¥˜ ë°œìƒ: " + e.message + 
      "<br/><small>LLM ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•˜ì„¸ìš”. ì„¤ì •ì—ì„œ ëª¨ë¸ì„ í™•ì¸í•˜ì„¸ìš”.</small></div>";
    console.error('Chat error:', e);
  }
}
</script>
</body>
</html>
